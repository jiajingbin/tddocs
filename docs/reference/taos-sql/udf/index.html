<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/tddocs/blog/rss.xml" title="TDengine æ–‡æ¡£ï¼ˆé¢„è§ˆï¼‰ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tddocs/blog/atom.xml" title="TDengine æ–‡æ¡£ï¼ˆé¢„è§ˆï¼‰ Atom Feed"><title data-react-helmet="true">UDFï¼ˆç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰ | TDengine æ–‡æ¡£ï¼ˆé¢„è§ˆï¼‰</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://dingbo8128.github.io/tddocs/docs/reference/taos-sql/udf"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="UDFï¼ˆç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰ | TDengine æ–‡æ¡£ï¼ˆé¢„è§ˆï¼‰"><meta data-react-helmet="true" name="description" content="åœ¨æœ‰äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œåº”ç”¨é€»è¾‘éœ€è¦çš„æŸ¥è¯¢æ— æ³•ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„å‡½æ•°æ¥è¡¨ç¤ºã€‚åˆ©ç”¨ UDF åŠŸèƒ½ï¼ŒTDengine å¯ä»¥æ’å…¥ç”¨æˆ·ç¼–å†™çš„å¤„ç†ä»£ç å¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå°±èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è§£å†³ç‰¹æ®Šåº”ç”¨åœºæ™¯ä¸­çš„ä½¿ç”¨éœ€æ±‚ã€‚ UDF é€šå¸¸ä»¥æ•°æ®è¡¨ä¸­çš„ä¸€åˆ—æ•°æ®åšä¸ºè¾“å…¥ï¼ŒåŒæ—¶æ”¯æŒä»¥åµŒå¥—å­æŸ¥è¯¢çš„ç»“æœä½œä¸ºè¾“å…¥ã€‚"><meta data-react-helmet="true" property="og:description" content="åœ¨æœ‰äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œåº”ç”¨é€»è¾‘éœ€è¦çš„æŸ¥è¯¢æ— æ³•ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„å‡½æ•°æ¥è¡¨ç¤ºã€‚åˆ©ç”¨ UDF åŠŸèƒ½ï¼ŒTDengine å¯ä»¥æ’å…¥ç”¨æˆ·ç¼–å†™çš„å¤„ç†ä»£ç å¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå°±èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è§£å†³ç‰¹æ®Šåº”ç”¨åœºæ™¯ä¸­çš„ä½¿ç”¨éœ€æ±‚ã€‚ UDF é€šå¸¸ä»¥æ•°æ®è¡¨ä¸­çš„ä¸€åˆ—æ•°æ®åšä¸ºè¾“å…¥ï¼ŒåŒæ—¶æ”¯æŒä»¥åµŒå¥—å­æŸ¥è¯¢çš„ç»“æœä½œä¸ºè¾“å…¥ã€‚"><link data-react-helmet="true" rel="icon" href="/tddocs/img/tdengine.ico"><link data-react-helmet="true" rel="canonical" href="https://dingbo8128.github.io/tddocs/docs/reference/taos-sql/udf"><link data-react-helmet="true" rel="alternate" href="https://dingbo8128.github.io/tddocs/docs/reference/taos-sql/udf" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dingbo8128.github.io/tddocs/docs/reference/taos-sql/udf" hreflang="x-default"><link rel="stylesheet" href="/tddocs/assets/css/styles.0c9264a6.css">
<link rel="preload" href="/tddocs/assets/js/runtime~main.aa837c80.js" as="script">
<link rel="preload" href="/tddocs/assets/js/main.74ab57da.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tddocs/"><div class="navbar__logo"><img src="/tddocs/img/logo.jpg" alt="TDengine" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/tddocs/img/logo.jpg" alt="TDengine" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">TDengine</b></a><a class="navbar__item navbar__link navbar__link--active" href="/tddocs/docs/">æ–‡æ¡£</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/taosdata/TDengine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ğŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ğŸŒ</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/">TDengine ä»‹ç»</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/getting-started/quick-install">ç«‹å³å¼€å§‹</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/guide/model">ä½¿ç”¨æŒ‡å—</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/tddocs/docs/reference/taos-sql/tsql">å‚è€ƒæŒ‡å—</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/tddocs/docs/reference/taos-sql/tsql">TAOS SQL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tddocs/docs/reference/taos-sql/tsql">SQL æ‰‹å†Œ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tddocs/docs/reference/taos-sql/udf">UDFï¼ˆç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/tddocs/docs/reference/taos-sql/errorcode">é”™è¯¯ç </a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/tddocs/docs/reference/connector/">è¿æ¥å™¨</a><button aria-label="Toggle the collapsible sidebar category &#x27;è¿æ¥å™¨&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tddocs/docs/reference/support-platform">æ”¯æŒå¹³å°åˆ—è¡¨</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/third-party/grafana">ç¬¬ä¸‰æ–¹å·¥å…·</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/opreration/cluster">è¿ç»´æŒ‡å—</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/tech-share/arch">æŠ€æœ¯åˆ†äº«</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/tddocs/docs/train-fqa/faq">åŸ¹è®­å’ŒFAQ</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_cwdi"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_xORG"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>UDFï¼ˆç”¨æˆ·å®šä¹‰å‡½æ•°ï¼‰</h1><p>åœ¨æœ‰äº›åº”ç”¨åœºæ™¯ä¸­ï¼Œåº”ç”¨é€»è¾‘éœ€è¦çš„æŸ¥è¯¢æ— æ³•ç›´æ¥ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„å‡½æ•°æ¥è¡¨ç¤ºã€‚åˆ©ç”¨ UDF åŠŸèƒ½ï¼ŒTDengine å¯ä»¥æ’å…¥ç”¨æˆ·ç¼–å†™çš„å¤„ç†ä»£ç å¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå°±èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°è§£å†³ç‰¹æ®Šåº”ç”¨åœºæ™¯ä¸­çš„ä½¿ç”¨éœ€æ±‚ã€‚ UDF é€šå¸¸ä»¥æ•°æ®è¡¨ä¸­çš„ä¸€åˆ—æ•°æ®åšä¸ºè¾“å…¥ï¼ŒåŒæ—¶æ”¯æŒä»¥åµŒå¥—å­æŸ¥è¯¢çš„ç»“æœä½œä¸ºè¾“å…¥ã€‚</p><p>ä» 2.2.0.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒTDengine æ”¯æŒé€šè¿‡ C/C++ è¯­è¨€è¿›è¡Œ UDF å®šä¹‰ã€‚æ¥ä¸‹æ¥ç»“åˆç¤ºä¾‹è®²è§£ UDF çš„ä½¿ç”¨æ–¹æ³•ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ç”¨-cc-è¯­è¨€æ¥å®šä¹‰-udf">ç”¨ C/C++ è¯­è¨€æ¥å®šä¹‰ UDF<a class="hash-link" href="#ç”¨-cc-è¯­è¨€æ¥å®šä¹‰-udf" title="Direct link to heading">â€‹</a></h2><p>TDengine æä¾› 3 ä¸ª UDF çš„æºä»£ç ç¤ºä¾‹ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ul><li><a href="#add_one.c">add_one.c</a></li><li><a href="#abs_max.c">abs_max.c</a></li><li><a href="#demo.c">demo.c</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="æ ‡é‡å‡½æ•°">æ ‡é‡å‡½æ•°<a class="hash-link" href="#æ ‡é‡å‡½æ•°" title="Direct link to heading">â€‹</a></h3><p><a href="https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/add_one.c" target="_blank" rel="noopener noreferrer">add_one.c</a> æ˜¯ç»“æ„æœ€ç®€å•çš„ UDF å®ç°ã€‚å…¶åŠŸèƒ½ä¸ºï¼šå¯¹ä¼ å…¥çš„ä¸€ä¸ªæ•°æ®åˆ—ï¼ˆå¯èƒ½å›  WHERE å­å¥è¿›è¡Œäº†ç­›é€‰ï¼‰ä¸­çš„æ¯ä¸€é¡¹ï¼Œéƒ½è¾“å‡º +1 ä¹‹åçš„å€¼ï¼Œå¹¶ä¸”è¦æ±‚è¾“å…¥çš„åˆ—æ•°æ®ç±»å‹ä¸º INTã€‚ </p><p>è¿™ä¸€å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨å‡½æ•° <code>void add_one(char* data, short itype, short ibytes, int numOfRows, long long* ts, char* dataOutput, char* interBuf, char* tsOutput, int* numOfOutput, short otype, short obytes, SUdfInit* buf)</code> ä¸­å®šä¹‰ã€‚è¿™ç±»ç”¨äºå®ç° UDF çš„åŸºç¡€è®¡ç®—é€»è¾‘çš„å‡½æ•°ï¼Œæˆ‘ä»¬ç§°ä¸º udfNormalFuncï¼Œä¹Ÿå°±æ˜¯å¯¹è¡Œæ•°æ®å—çš„æ ‡é‡è®¡ç®—å‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒudfNormalFunc çš„å‚æ•°é¡¹æ˜¯å›ºå®šçš„ï¼Œç”¨äºæŒ‰ç…§çº¦æŸå®Œæˆä¸å¼•æ“ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚</p><ul><li>udfNormalFunc ä¸­å„å‚æ•°çš„å…·ä½“å«ä¹‰æ˜¯ï¼š<ul><li>dataï¼šè¾“å…¥æ•°æ®ã€‚</li><li>itypeï¼šè¾“å…¥æ•°æ®çš„ç±»å‹ã€‚è¿™é‡Œé‡‡ç”¨çš„æ˜¯çŸ­æ•´å‹è¡¨ç¤ºæ³•ï¼Œä¸å„ç§æ•°æ®ç±»å‹å¯¹åº”çš„å€¼å¯ä»¥å‚è§ <a href="https://www.taosdata.com/cn/documentation/connector#column_meta" target="_blank" rel="noopener noreferrer">column_meta ä¸­çš„åˆ—ç±»å‹è¯´æ˜</a>ã€‚ä¾‹å¦‚ 4 ç”¨äºè¡¨ç¤º INT å‹ã€‚</li><li>iBytesï¼šè¾“å…¥æ•°æ®ä¸­æ¯ä¸ªå€¼ä¼šå ç”¨çš„å­—èŠ‚æ•°ã€‚</li><li>numOfRowsï¼šè¾“å…¥æ•°æ®çš„æ€»è¡Œæ•°ã€‚</li><li>tsï¼šä¸»é”®æ—¶é—´æˆ³åœ¨è¾“å…¥ä¸­çš„åˆ—æ•°æ®(åªè¯»)ã€‚</li><li>dataOutputï¼šè¾“å‡ºæ•°æ®çš„ç¼“å†²åŒºï¼Œç¼“å†²åŒºå¤§å°ä¸ºç”¨æˆ·æŒ‡å®šçš„è¾“å‡ºç±»å‹å¤§å° * numOfRowsã€‚</li><li>interBufï¼šä¸­é—´è®¡ç®—ç»“æœçš„ç¼“å†²åŒºï¼Œå¤§å°ä¸ºç”¨æˆ·åœ¨åˆ›å»º UDF æ—¶æŒ‡å®šçš„BUFSIZEå¤§å°ã€‚é€šå¸¸ç”¨äºè®¡ç®—ä¸­é—´ç»“æœä¸æœ€ç»ˆç»“æœä¸ä¸€è‡´æ—¶ä½¿ç”¨ï¼Œç”±å¼•æ“è´Ÿè´£åˆ†é…ä¸é‡Šæ”¾ã€‚</li><li>tsOutputï¼šä¸»é”®æ—¶é—´æˆ³åœ¨è¾“å‡ºæ—¶çš„åˆ—æ•°æ®ï¼Œå¦‚æœéç©ºå¯ç”¨äºè¾“å‡ºç»“æœå¯¹åº”çš„æ—¶é—´æˆ³ã€‚</li><li>numOfOutputï¼šè¾“å‡ºç»“æœçš„ä¸ªæ•°ï¼ˆè¡Œæ•°ï¼‰ã€‚</li><li>oTypeï¼šè¾“å‡ºæ•°æ®çš„ç±»å‹ã€‚å–å€¼å«ä¹‰ä¸ itype å‚æ•°ä¸€è‡´ã€‚</li><li>oBytesï¼šè¾“å‡ºæ•°æ®ä¸­æ¯ä¸ªå€¼å ç”¨çš„å­—èŠ‚æ•°ã€‚</li><li>bufï¼šç”¨äºåœ¨ UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="èšåˆå‡½æ•°">èšåˆå‡½æ•°<a class="hash-link" href="#èšåˆå‡½æ•°" title="Direct link to heading">â€‹</a></h3><p><a href="https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/abs_max.c" target="_blank" rel="noopener noreferrer">abs_max.c</a> å®ç°çš„æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼ŒåŠŸèƒ½æ˜¯å¯¹ä¸€ç»„æ•°æ®æŒ‰ç»å¯¹å€¼å–æœ€å¤§å€¼ã€‚</p><p>å…¶è®¡ç®—è¿‡ç¨‹ä¸ºï¼šä¸æ‰€åœ¨æŸ¥è¯¢è¯­å¥ç›¸å…³çš„æ•°æ®ä¼šè¢«åˆ†ä¸ºå¤šä¸ªè¡Œæ•°æ®å—ï¼Œå¯¹æ¯ä¸ªè¡Œæ•°æ®å—è°ƒç”¨ udfNormalFuncï¼ˆåœ¨æœ¬ä¾‹çš„å®ç°ä»£ç ä¸­ï¼Œå®é™…å‡½æ•°åæ˜¯ <code>abs_max</code>)æ¥ç”Ÿæˆæ¯ä¸ªå­è¡¨çš„ä¸­é—´ç»“æœï¼Œå†å°†å­è¡¨çš„ä¸­é—´ç»“æœè°ƒç”¨ udfMergeFuncï¼ˆæœ¬ä¾‹ä¸­ï¼Œå…¶å®é™…çš„å‡½æ•°åæ˜¯ <code>abs_max_merge</code>ï¼‰è¿›è¡Œèšåˆï¼Œç”Ÿæˆè¶…çº§è¡¨çš„æœ€ç»ˆèšåˆç»“æœæˆ–ä¸­é—´ç»“æœã€‚èšåˆæŸ¥è¯¢æœ€åè¿˜ä¼šé€šè¿‡ udfFinalizeFuncï¼ˆæœ¬ä¾‹ä¸­ï¼Œå…¶å®é™…çš„å‡½æ•°åæ˜¯ <code>abs_max_finalize</code>ï¼‰å†æŠŠè¶…çº§è¡¨çš„ä¸­é—´ç»“æœå¤„ç†ä¸ºæœ€ç»ˆç»“æœï¼Œæœ€ç»ˆç»“æœåªèƒ½å«0æˆ–1æ¡ç»“æœæ•°æ®ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒudfNormalFuncã€udfMergeFuncã€udfFinalizeFunc ä¹‹é—´ï¼Œå‡½æ•°åçº¦å®šä½¿ç”¨ç›¸åŒçš„å‰ç¼€ï¼Œæ­¤å‰ç¼€å³ udfNormalFunc çš„å®é™…å‡½æ•°åã€‚udfMergeFunc çš„å‡½æ•°ååç¼€ <code>_merge</code>ã€udfFinalizeFunc çš„å‡½æ•°ååç¼€ <code>_finalize</code>ï¼Œæ˜¯ UDF å®ç°è§„åˆ™çš„ä¸€éƒ¨åˆ†ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§è¿™äº›å‡½æ•°ååç¼€æ¥è°ƒç”¨ç›¸åº”åŠŸèƒ½ã€‚</p><ul><li><p>udfMergeFunc ç”¨äºå¯¹è®¡ç®—ä¸­é—´ç»“æœè¿›è¡Œèšåˆï¼Œåªæœ‰é’ˆå¯¹è¶…çº§è¡¨çš„èšåˆæŸ¥è¯¢æ‰éœ€è¦è°ƒç”¨è¯¥å‡½æ•°ã€‚æœ¬ä¾‹ä¸­ udfMergeFunc å¯¹åº”çš„å®ç°å‡½æ•°ä¸º <code>void abs_max_merge(char* data, int32_t numOfRows, char* dataOutput, int32_t* numOfOutput, SUdfInit* buf)</code>ï¼Œå…¶ä¸­å„å‚æ•°çš„å…·ä½“å«ä¹‰æ˜¯ï¼š</p><ul><li>dataï¼šudfNormalFunc çš„è¾“å‡ºæ•°æ®æ•°ç»„ï¼Œå¦‚æœä½¿ç”¨äº† interBuf é‚£ä¹ˆ data å°±æ˜¯ interBuf çš„æ•°ç»„ã€‚</li><li>numOfRowsï¼šdata ä¸­æ•°æ®çš„è¡Œæ•°ã€‚</li><li>dataOutputï¼šè¾“å‡ºæ•°æ®çš„ç¼“å†²åŒºï¼Œå¤§å°ç­‰äºä¸€æ¡æœ€ç»ˆç»“æœçš„å¤§å°ã€‚å¦‚æœæ­¤æ—¶è¾“å‡ºè¿˜ä¸æ˜¯æœ€ç»ˆç»“æœï¼Œå¯ä»¥é€‰æ‹©è¾“å‡ºåˆ° interBuf ä¸­å³dataä¸­ã€‚</li><li>numOfOutputï¼šè¾“å‡ºç»“æœçš„ä¸ªæ•°ï¼ˆè¡Œæ•°ï¼‰ã€‚</li><li>bufï¼šç”¨äºåœ¨ UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚</li></ul></li><li><p>udfFinalizeFunc ç”¨äºå¯¹è®¡ç®—ç»“æœè¿›è¡Œæœ€ç»ˆè®¡ç®—ï¼Œé€šå¸¸ç”¨äºæœ‰ interBuf ä½¿ç”¨çš„åœºæ™¯ã€‚æœ¬ä¾‹ä¸­ udfFinalizeFunc å¯¹åº”çš„å®ç°å‡½æ•°ä¸º <code>void abs_max_finalize(char* dataOutput, char* interBuf, int* numOfOutput, SUdfInit* buf)</code>ï¼Œå…¶ä¸­å„å‚æ•°çš„å…·ä½“å«ä¹‰æ˜¯ï¼š</p><ul><li>dataOutputï¼šè¾“å‡ºæ•°æ®çš„ç¼“å†²åŒºã€‚</li><li>interBufï¼šä¸­é—´ç»“ç®—ç»“æœç¼“å†²åŒºï¼Œå¯ä½œä¸ºè¾“å…¥ã€‚</li><li>numOfOutputï¼šè¾“å‡ºæ•°æ®çš„ä¸ªæ•°ï¼Œå¯¹èšåˆå‡½æ•°æ¥è¯´åªèƒ½æ˜¯0æˆ–è€…1ã€‚</li><li>bufï¼šç”¨äºåœ¨ UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚</li></ul></li></ul><p>å…¶ä»–å…¸å‹åœºæ™¯ï¼Œå¦‚åæ–¹å·®çš„è®¡ç®—ï¼Œå³å¯é€šè¿‡å®šä¹‰èšåˆUDFçš„æ–¹å¼å®ç°ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="å…¶ä»–-udf-å‡½æ•°">å…¶ä»– UDF å‡½æ•°<a class="hash-link" href="#å…¶ä»–-udf-å‡½æ•°" title="Direct link to heading">â€‹</a></h3><p>ç”¨æˆ· UDF ç¨‹åºé™¤äº†éœ€è¦å®ç°ä¸Šé¢å‡ ä¸ªå‡½æ•°å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç”¨äºåˆå§‹åŒ–å’Œé‡Šæ”¾ UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—çš„å‡½æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œä¹Ÿå³å¯¹åº” udfInitFunc å’Œ udfDestroyFuncã€‚å…¶å‡½æ•°åå‘½åè§„åˆ™åŒæ ·æ˜¯é‡‡å–ä»¥ udfNormalFunc çš„å®é™…å‡½æ•°åä¸ºå‰ç¼€ï¼Œä»¥ <code>_init</code> å’Œ <code>_destroy</code> ä¸ºåç¼€ã€‚ç³»ç»Ÿä¼šåœ¨åˆå§‹åŒ–å’Œèµ„æºé‡Šæ”¾æ—¶è°ƒç”¨å¯¹åº”åç§°çš„å‡½æ•°ã€‚</p><ul><li><p>udfInitFunc ç”¨äºåˆå§‹åŒ–çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚ä¸Šä¾‹ä¸­ udfInitFunc å¯¹åº”çš„å®ç°å‡½æ•°ä¸º <code>int abs_max_init(SUdfInit* buf)</code>ï¼Œå…¶ä¸­å„å‚æ•°çš„å…·ä½“å«ä¹‰æ˜¯ï¼š</p><ul><li>bufï¼šç”¨äºåœ¨  UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚</li></ul></li><li><p>udfDestroyFunc ç”¨äºé‡Šæ”¾çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚ä¸Šä¾‹ä¸­ udfDestroyFunc å¯¹åº”çš„å®ç°å‡½æ•°ä¸º <code>void abs_max_destroy(SUdfInit* buf)</code>ï¼Œå…¶ä¸­å„å‚æ•°çš„å…·ä½“å«ä¹‰æ˜¯ï¼š</p><ul><li>bufï¼šç”¨äºåœ¨  UDF ä¸å¼•æ“é—´çš„çŠ¶æ€æ§åˆ¶ä¿¡æ¯ä¼ é€’å—ã€‚</li></ul></li></ul><p>ç›®å‰è¯¥åŠŸèƒ½æš‚æ—¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œå¾…åç»­æ‰©å±•ä½¿ç”¨ã€‚</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="udf-å®ç°æ–¹å¼çš„è§„åˆ™æ€»ç»“">UDF å®ç°æ–¹å¼çš„è§„åˆ™æ€»ç»“<a class="hash-link" href="#udf-å®ç°æ–¹å¼çš„è§„åˆ™æ€»ç»“" title="Direct link to heading">â€‹</a></h3><p>æ ¹æ® UDF å‡½æ•°ç±»å‹çš„ä¸åŒï¼Œç”¨æˆ·æ‰€è¦å®ç°çš„åŠŸèƒ½å‡½æ•°ä¹Ÿä¸åŒï¼š</p><ul><li>æ ‡é‡å‡½æ•°ï¼šUDF ä¸­éœ€å®ç° udfNormalFuncã€‚</li><li>èšåˆå‡½æ•°ï¼šUDF ä¸­éœ€å®ç° udfNormalFuncã€udfMergeFuncï¼ˆå¯¹è¶…çº§è¡¨æŸ¥è¯¢ï¼‰ã€udfFinalizeFuncã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå¯¹åº”çš„å‡½æ•°ä¸éœ€è¦å…·ä½“çš„åŠŸèƒ½ï¼Œä¹Ÿéœ€è¦å®ç°ä¸€ä¸ªç©ºå‡½æ•°ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ç¼–è¯‘-udf">ç¼–è¯‘ UDF<a class="hash-link" href="#ç¼–è¯‘-udf" title="Direct link to heading">â€‹</a></h2><p>ç”¨æˆ·å®šä¹‰å‡½æ•°çš„ C è¯­è¨€æºä»£ç æ— æ³•ç›´æ¥è¢« TDengine ç³»ç»Ÿä½¿ç”¨ï¼Œè€Œæ˜¯éœ€è¦å…ˆç¼–è¯‘ä¸º .so é“¾æ¥åº“ï¼Œä¹‹åæ‰èƒ½è½½å…¥ TDengine ç³»ç»Ÿã€‚</p><p>ä¾‹å¦‚ï¼ŒæŒ‰ç…§ä¸Šä¸€ç« èŠ‚æè¿°çš„è§„åˆ™å‡†å¤‡å¥½äº†ç”¨æˆ·å®šä¹‰å‡½æ•°çš„æºä»£ç  add_one.cï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ç¼–è¯‘å¾—åˆ°åŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼š</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -g -O0 -fPIC -shared add_one.c -o add_one.so</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>è¿™æ ·å°±å‡†å¤‡å¥½äº†åŠ¨æ€é“¾æ¥åº“ add_one.so æ–‡ä»¶ï¼Œå¯ä»¥ä¾›åæ–‡åˆ›å»º UDF æ—¶ä½¿ç”¨äº†ã€‚ä¸ºäº†ä¿è¯å¯é çš„ç³»ç»Ÿè¿è¡Œï¼Œç¼–è¯‘å™¨ GCC æ¨èä½¿ç”¨ 7.5åŠä»¥ä¸Šç‰ˆæœ¬ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="åœ¨ç³»ç»Ÿä¸­ç®¡ç†å’Œä½¿ç”¨-udf">åœ¨ç³»ç»Ÿä¸­ç®¡ç†å’Œä½¿ç”¨ UDF<a class="hash-link" href="#åœ¨ç³»ç»Ÿä¸­ç®¡ç†å’Œä½¿ç”¨-udf" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="åˆ›å»º-udf">åˆ›å»º UDF<a class="hash-link" href="#åˆ›å»º-udf" title="Direct link to heading">â€‹</a></h3><p>ç”¨æˆ·å¯ä»¥é€šè¿‡ SQL æŒ‡ä»¤åœ¨ç³»ç»Ÿä¸­åŠ è½½å®¢æˆ·ç«¯æ‰€åœ¨ä¸»æœºä¸Šçš„ UDF å‡½æ•°åº“ï¼ˆä¸èƒ½é€šè¿‡ RESTful æ¥å£æˆ– HTTP ç®¡ç†ç•Œé¢æ¥è¿›è¡Œè¿™ä¸€è¿‡ç¨‹ï¼‰ã€‚ä¸€æ—¦åˆ›å»ºæˆåŠŸï¼Œåˆ™å½“å‰ TDengine é›†ç¾¤çš„æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥åœ¨ SQL æŒ‡ä»¤ä¸­ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚UDF å­˜å‚¨åœ¨ç³»ç»Ÿçš„ MNode èŠ‚ç‚¹ä¸Šï¼Œå› æ­¤å³ä½¿é‡å¯ TDengine ç³»ç»Ÿï¼Œå·²ç»åˆ›å»ºçš„ UDF ä¹Ÿä»ç„¶å¯ç”¨ã€‚</p><p>åœ¨åˆ›å»º UDF æ—¶ï¼Œéœ€è¦åŒºåˆ†æ ‡é‡å‡½æ•°å’Œèšåˆå‡½æ•°ã€‚å¦‚æœåˆ›å»ºæ—¶å£°æ˜äº†é”™è¯¯çš„å‡½æ•°ç±»åˆ«ï¼Œåˆ™å¯èƒ½å¯¼è‡´é€šè¿‡ SQL æŒ‡ä»¤è°ƒç”¨å‡½æ•°æ—¶å‡ºé”™ã€‚æ­¤å¤–ï¼Œ UDF æ”¯æŒè¾“å…¥ä¸è¾“å‡ºç±»å‹ä¸ä¸€è‡´ï¼Œç”¨æˆ·éœ€è¦ä¿è¯è¾“å…¥æ•°æ®ç±»å‹ä¸ UDF ç¨‹åºåŒ¹é…ï¼ŒUDF è¾“å‡ºæ•°æ®ç±»å‹ä¸ OUTPUTTYPE åŒ¹é…ã€‚</p><ul><li><p>åˆ›å»ºæ ‡é‡å‡½æ•°ï¼š<code>CREATE FUNCTION ids(X) AS ids(Y) OUTPUTTYPE typename(Z) [ BUFSIZE B ];</code></p><ul><li>ids(X)ï¼šæ ‡é‡å‡½æ•°æœªæ¥åœ¨ SQL æŒ‡ä»¤ä¸­è¢«è°ƒç”¨æ—¶çš„å‡½æ•°åï¼Œå¿…é¡»ä¸å‡½æ•°å®ç°ä¸­ udfNormalFunc çš„å®é™…åç§°ä¸€è‡´ï¼›</li><li>ids(Y)ï¼šåŒ…å« UDF å‡½æ•°å®ç°çš„åŠ¨æ€é“¾æ¥åº“çš„åº“æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼ˆæŒ‡çš„æ˜¯åº“æ–‡ä»¶åœ¨å½“å‰å®¢æˆ·ç«¯æ‰€åœ¨ä¸»æœºä¸Šçš„ä¿å­˜è·¯å¾„ï¼Œé€šå¸¸æ˜¯æŒ‡å‘ä¸€ä¸ª .so æ–‡ä»¶ï¼‰ï¼Œè¿™ä¸ªè·¯å¾„éœ€è¦ç”¨è‹±æ–‡å•å¼•å·æˆ–è‹±æ–‡åŒå¼•å·æ‹¬èµ·æ¥ï¼›</li><li>typename(Z)ï¼šæ­¤å‡½æ•°è®¡ç®—ç»“æœçš„æ•°æ®ç±»å‹ï¼Œä¸ä¸Šæ–‡ä¸­ udfNormalFunc çš„ itype å‚æ•°ä¸åŒï¼Œè¿™é‡Œä¸æ˜¯ä½¿ç”¨æ•°å­—è¡¨ç¤ºæ³•ï¼Œè€Œæ˜¯ç›´æ¥å†™ç±»å‹åç§°å³å¯ï¼›</li><li>Bï¼šä¸­é—´è®¡ç®—ç»“æœçš„ç¼“å†²åŒºå¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œæœ€å° 0ï¼Œæœ€å¤§ 512ï¼Œå¦‚æœä¸ä½¿ç”¨å¯ä»¥ä¸è®¾ç½®ã€‚</li></ul><p>ä¾‹å¦‚ï¼Œå¦‚ä¸‹è¯­å¥å¯ä»¥æŠŠ add_one.so åˆ›å»ºä¸ºç³»ç»Ÿä¸­å¯ç”¨çš„ UDFï¼š</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> add_one </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/home/taos/udf_example/add_one.so&quot;</span><span class="token plain"> OUTPUTTYPE </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li><li><p>åˆ›å»ºèšåˆå‡½æ•°ï¼š<code>CREATE AGGREGATE FUNCTION ids(X) AS ids(Y) OUTPUTTYPE typename(Z) [ BUFSIZE B ];</code></p><ul><li>ids(X)ï¼šèšåˆå‡½æ•°æœªæ¥åœ¨ SQL æŒ‡ä»¤ä¸­è¢«è°ƒç”¨æ—¶çš„å‡½æ•°åï¼Œå¿…é¡»ä¸å‡½æ•°å®ç°ä¸­ udfNormalFunc çš„å®é™…åç§°ä¸€è‡´ï¼›</li><li>ids(Y)ï¼šåŒ…å« UDF å‡½æ•°å®ç°çš„åŠ¨æ€é“¾æ¥åº“çš„åº“æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼ˆæŒ‡çš„æ˜¯åº“æ–‡ä»¶åœ¨å½“å‰å®¢æˆ·ç«¯æ‰€åœ¨ä¸»æœºä¸Šçš„ä¿å­˜è·¯å¾„ï¼Œé€šå¸¸æ˜¯æŒ‡å‘ä¸€ä¸ª .so æ–‡ä»¶ï¼‰ï¼Œè¿™ä¸ªè·¯å¾„éœ€è¦ç”¨è‹±æ–‡å•å¼•å·æˆ–è‹±æ–‡åŒå¼•å·æ‹¬èµ·æ¥ï¼›</li><li>typename(Z)ï¼šæ­¤å‡½æ•°è®¡ç®—ç»“æœçš„æ•°æ®ç±»å‹ï¼Œä¸ä¸Šæ–‡ä¸­ udfNormalFunc çš„ itype å‚æ•°ä¸åŒï¼Œè¿™é‡Œä¸æ˜¯ä½¿ç”¨æ•°å­—è¡¨ç¤ºæ³•ï¼Œè€Œæ˜¯ç›´æ¥å†™ç±»å‹åç§°å³å¯ï¼›</li><li>Bï¼šä¸­é—´è®¡ç®—ç»“æœçš„ç¼“å†²åŒºå¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œæœ€å° 0ï¼Œæœ€å¤§ 512ï¼Œå¦‚æœä¸ä½¿ç”¨å¯ä»¥ä¸è®¾ç½®ã€‚</li></ul><p>å…³äºä¸­é—´è®¡ç®—ç»“æœçš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒç¤ºä¾‹ç¨‹åº<a href="https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/demo.c" target="_blank" rel="noopener noreferrer">demo.c</a></p><p>ä¾‹å¦‚ï¼Œå¦‚ä¸‹è¯­å¥å¯ä»¥æŠŠ demo.so åˆ›å»ºä¸ºç³»ç»Ÿä¸­å¯ç”¨çš„ UDFï¼š</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> AGGREGATE </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> demo </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/home/taos/udf_example/demo.so&quot;</span><span class="token plain"> OUTPUTTYPE </span><span class="token keyword" style="color:#00009f">DOUBLE</span><span class="token plain"> bufsize </span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ç®¡ç†-udf">ç®¡ç† UDF<a class="hash-link" href="#ç®¡ç†-udf" title="Direct link to heading">â€‹</a></h3><ul><li>åˆ é™¤æŒ‡å®šåç§°çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼š<code>DROP FUNCTION ids(X);</code><ul><li>ids(X)ï¼šæ­¤å‚æ•°çš„å«ä¹‰ä¸ CREATE æŒ‡ä»¤ä¸­çš„ ids(X) å‚æ•°ä¸€è‡´ï¼Œä¹Ÿå³è¦åˆ é™¤çš„å‡½æ•°çš„åå­—ï¼Œä¾‹å¦‚ <code>DROP FUNCTION add_one;</code>ã€‚</li></ul></li><li>æ˜¾ç¤ºç³»ç»Ÿä¸­å½“å‰å¯ç”¨çš„æ‰€æœ‰ UDFï¼š<code>SHOW FUNCTIONS;</code></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="è°ƒç”¨-udf">è°ƒç”¨ UDF<a class="hash-link" href="#è°ƒç”¨-udf" title="Direct link to heading">â€‹</a></h3><p>åœ¨ SQL æŒ‡ä»¤ä¸­ï¼Œå¯ä»¥ç›´æ¥ä»¥åœ¨ç³»ç»Ÿä¸­åˆ›å»º UDF æ—¶èµ‹äºˆçš„å‡½æ•°åæ¥è°ƒç”¨ç”¨æˆ·å®šä¹‰å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stable</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>è¡¨ç¤ºå¯¹åä¸º c çš„æ•°æ®åˆ—è°ƒç”¨åä¸º X çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ã€‚SQL æŒ‡ä»¤ä¸­ç”¨æˆ·å®šä¹‰å‡½æ•°å¯ä»¥é…åˆ WHERE ç­‰æŸ¥è¯¢ç‰¹æ€§æ¥ä½¿ç”¨ã€‚</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="udf-çš„ä¸€äº›ä½¿ç”¨é™åˆ¶">UDF çš„ä¸€äº›ä½¿ç”¨é™åˆ¶<a class="hash-link" href="#udf-çš„ä¸€äº›ä½¿ç”¨é™åˆ¶" title="Direct link to heading">â€‹</a></h2><p>åœ¨å½“å‰ç‰ˆæœ¬ä¸‹ï¼Œä½¿ç”¨ UDF å­˜åœ¨å¦‚ä¸‹è¿™äº›é™åˆ¶ï¼š</p><ol><li>åœ¨åˆ›å»ºå’Œè°ƒç”¨ UDF æ—¶ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½åªæ”¯æŒ Linux æ“ä½œç³»ç»Ÿï¼›</li><li>UDF ä¸èƒ½ä¸ç³»ç»Ÿå†…å»ºçš„ SQL å‡½æ•°æ··åˆä½¿ç”¨ï¼Œæš‚ä¸æ”¯æŒåœ¨ä¸€æ¡ SQL è¯­å¥ä¸­ä½¿ç”¨å¤šä¸ªä¸åŒåçš„ UDF ï¼›</li><li>UDF åªæ”¯æŒä»¥å•ä¸ªæ•°æ®åˆ—ä½œä¸ºè¾“å…¥ï¼›</li><li>UDF åªè¦åˆ›å»ºæˆåŠŸï¼Œå°±ä¼šè¢«æŒä¹…åŒ–å­˜å‚¨åˆ° MNode èŠ‚ç‚¹ä¸­ï¼›</li><li>æ— æ³•é€šè¿‡ RESTful æ¥å£æ¥åˆ›å»º UDFï¼›</li><li>UDF åœ¨ SQL ä¸­å®šä¹‰çš„å‡½æ•°åï¼Œå¿…é¡»ä¸ .so åº“æ–‡ä»¶å®ç°ä¸­çš„æ¥å£å‡½æ•°åå‰ç¼€ä¿æŒä¸€è‡´ï¼Œä¹Ÿå³å¿…é¡»æ˜¯ udfNormalFunc çš„åç§°ï¼Œè€Œä¸”ä¸å¯ä¸ TDengine ä¸­å·²æœ‰çš„å†…å»º SQL å‡½æ•°é‡åã€‚</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="ä»£ç é™„ä»¶">ä»£ç é™„ä»¶<a class="hash-link" href="#ä»£ç é™„ä»¶" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="add_onec"><a href="https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/add_one.c" target="_blank" rel="noopener noreferrer">add_one.c</a><a class="hash-link" href="#add_onec" title="Direct link to heading">â€‹</a></h3><span id="add_one.c"><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct SUdfInit{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int maybe_null;       /* 1 if function can return NULL */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int decimals;     /* for real functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> long long length;       /* For string functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> char  *ptr;            /* free pointer for function data */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int const_item;       /* 0 if result is independent of arguments */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} SUdfInit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void add_one(char* data, short itype, short ibytes, int numOfRows, long long* ts, char* dataOutput, char* interBUf, char* tsOutput,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int* numOfOutput, short otype, short obytes, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //  printf(&quot;add_one input data:%p, type:%d, rows:%d, ts:%p,%lld, dataoutput:%p, tsOutput:%p, numOfOutput:%p, buf:%p\n&quot;, data, itype, numOfRows, ts, *ts, dataOutput, tsOutput, numOfOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if (itype == 4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     for(i=0;i&lt;numOfRows;++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  printf(&quot;input %d - %d&quot;, i, *((int *)data + i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *((int *)dataOutput+i)=*((int *)data + i) + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      //  printf(&quot;, output %d\n&quot;, *((int *)dataOutput+i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (tsOutput) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         *(long long*)tsOutput=1000000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *numOfOutput=numOfRows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //  printf(&quot;add_one out, numOfOutput:%d\n&quot;, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></span>### [abs_max.c](https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/abs_max.c)<span id="abs_max.c"><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;inttypes.h&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct SUdfInit{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int maybe_null;       /* 1 if function can return NULL */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int decimals;     /* for real functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int64_t length;       /* For string functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> char  *ptr;            /* free pointer for function data */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int const_item;       /* 0 if result is independent of arguments */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} SUdfInit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define TSDB_DATA_INT_NULL              0x80000000L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define TSDB_DATA_BIGINT_NULL           0x8000000000000000L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void abs_max(char* data, short itype, short ibytes, int numOfRows, int64_t* ts, char* dataOutput, char* interBuf, char* tsOutput,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int* numOfOutput, short otype, short obytes, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int64_t r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max input data:%p, type:%d, rows:%d, ts:%p, %&quot; PRId64 &quot;, dataoutput:%p, tsOutput:%p, numOfOutput:%p, buf:%p\n&quot;, data, itype, numOfRows, ts, *ts, dataOutput, tsOutput, numOfOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if (itype == 5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     r=*(int64_t *)dataOutput;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *numOfOutput=0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     for(i=0;i&lt;numOfRows;++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (*((int64_t *)data + i) == TSDB_DATA_BIGINT_NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       //int64_t v = abs(*((int64_t *)data + i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       int64_t v = *((int64_t *)data + i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (v &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          v = 0 - v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       if (v &gt; r) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          r = v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *(int64_t *)dataOutput=r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   //   printf(&quot;abs_max out, dataoutput:%&quot; PRId64&quot;, numOfOutput:%d\n&quot;, *(int64_t *)dataOutput, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *numOfOutput=0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void abs_max_finalize(char* dataOutput, char* interBuf, int* numOfOutput, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   //int64_t r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max_finalize dataoutput:%p:%d, numOfOutput:%d, buf:%p\n&quot;, dataOutput, *dataOutput, *numOfOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max finalize, dataoutput:%&quot; PRId64&quot;, numOfOutput:%d\n&quot;, *(int64_t *)dataOutput, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void abs_max_merge(char* data, int32_t numOfRows, char* dataOutput, int32_t* numOfOutput, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int64_t r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if (numOfRows &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      r = *((int64_t *)data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max_merge numOfRows:%d, dataoutput:%p, buf:%p\n&quot;, numOfRows, dataOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   for (int i = 1; i &lt; numOfRows; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   //   printf(&quot;abs_max_merge %d - %&quot; PRId64&quot;\n&quot;, i, *((int64_t *)data + i));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (*((int64_t*)data + i) &gt; r) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        r= *((int64_t*)data + i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *(int64_t*)dataOutput=r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if (numOfRows &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *numOfOutput=0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max_merge, dataoutput:%&quot; PRId64&quot;, numOfOutput:%d\n&quot;, *(int64_t *)dataOutput, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int abs_max_init(SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void abs_max_destroy(SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // printf(&quot;abs_max destroy\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></span><h3 class="anchor anchorWithStickyNavbar_mojV" id="democ"><a href="https://github.com/taosdata/TDengine/blob/develop/tests/script/sh/demo.c" target="_blank" rel="noopener noreferrer">demo.c</a><a class="hash-link" href="#democ" title="Direct link to heading">â€‹</a></h3><span id="demo.c"><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;string.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct SUdfInit{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int maybe_null;       /* 1 if function can return NULL */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int decimals;     /* for real functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> long long length;       /* For string functions */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> char  *ptr;            /* free pointer for function data */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> int const_item;       /* 0 if result is independent of arguments */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} SUdfInit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct SDemo{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int num;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  short otype;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}SDemo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define FLOAT_NULL            0x7FF00000              // it is an NAN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define DOUBLE_NULL           0x7FFFFF0000000000L     // it is an NAN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void demo(char* data, short itype, short ibytes, int numOfRows, long long* ts, char* dataOutput, char* interBuf, char* tsOutput,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        int* numOfOutput, short otype, short obytes, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   double r = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SDemo *p = (SDemo *)interBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SDemo *q = (SDemo *)dataOutput;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo input data:%p, type:%d, rows:%d, ts:%p,%lld, dataoutput:%p, interBUf:%p, tsOutput:%p, numOfOutput:%p, buf:%p\n&quot;, data, itype, numOfRows, ts, *ts, dataOutput, interBuf, tsOutput, numOfOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   for(i=0;i&lt;numOfRows;++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (itype == 4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       r=*((int *)data+i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else if (itype == 6) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       r=*((float *)data+i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else if (itype == 7) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       r=*((double *)data+i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     p-&gt;sum += r*r;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p-&gt;otype = otype;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p-&gt;num += numOfRows;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   q-&gt;sum = p-&gt;sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   q-&gt;num = p-&gt;num;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   q-&gt;otype = p-&gt;otype;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo out, sum:%f, num:%d, numOfOutput:%d\n&quot;, p-&gt;sum, p-&gt;num, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void demo_merge(char* data, int32_t numOfRows, char* dataOutput, int32_t* numOfOutput, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SDemo *p = (SDemo *)data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SDemo res = {0};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo_merge input data:%p, rows:%d, dataoutput:%p, numOfOutput:%p, buf:%p\n&quot;, data, numOfRows, dataOutput, numOfOutput, buf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   for(i=0;i&lt;numOfRows;++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     res.sum += p-&gt;sum * p-&gt;sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     res.num += p-&gt;num;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     p++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p-&gt;sum = res.sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   p-&gt;num = res.num;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo out, sum:%f, num:%d, numOfOutput:%d\n&quot;, p-&gt;sum, p-&gt;num, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void demo_finalize(char* dataOutput, char* interBuf, int* numOfOutput, SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SDemo *p = (SDemo *)interBuf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo_finalize interbuf:%p, numOfOutput:%p, buf:%p, sum:%f, num:%d\n&quot;, interBuf, numOfOutput, buf, p-&gt;sum, p-&gt;num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   if (p-&gt;otype == 6) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (p-&gt;num != 30000) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *(unsigned int *)dataOutput = FLOAT_NULL;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *(float *)dataOutput = (float)(p-&gt;sum / p-&gt;num);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     printf(&quot;finalize values:%f\n&quot;, *(float *)dataOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } else if (p-&gt;otype == 7) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (p-&gt;num != 30000) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *(unsigned long long *)dataOutput = DOUBLE_NULL;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else {    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       *(double *)dataOutput = (double)(p-&gt;sum / p-&gt;num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     printf(&quot;finalize values:%f\n&quot;, *(double *)dataOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *numOfOutput=1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo finalize, numOfOutput:%d\n&quot;, *numOfOutput);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int demo_init(SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo init\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void demo_destroy(SUdfInit* buf) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   printf(&quot;demo destroy\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></span></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dingbo8128/tddocs/edit/main/docs/reference/taos-sql/udf.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tddocs/docs/reference/taos-sql/tsql"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SQL æ‰‹å†Œ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tddocs/docs/reference/taos-sql/errorcode"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">é”™è¯¯ç </div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ç”¨-cc-è¯­è¨€æ¥å®šä¹‰-udf" class="table-of-contents__link toc-highlight">ç”¨ C/C++ è¯­è¨€æ¥å®šä¹‰ UDF</a><ul><li><a href="#æ ‡é‡å‡½æ•°" class="table-of-contents__link toc-highlight">æ ‡é‡å‡½æ•°</a></li><li><a href="#èšåˆå‡½æ•°" class="table-of-contents__link toc-highlight">èšåˆå‡½æ•°</a></li><li><a href="#å…¶ä»–-udf-å‡½æ•°" class="table-of-contents__link toc-highlight">å…¶ä»– UDF å‡½æ•°</a></li><li><a href="#udf-å®ç°æ–¹å¼çš„è§„åˆ™æ€»ç»“" class="table-of-contents__link toc-highlight">UDF å®ç°æ–¹å¼çš„è§„åˆ™æ€»ç»“</a></li></ul></li><li><a href="#ç¼–è¯‘-udf" class="table-of-contents__link toc-highlight">ç¼–è¯‘ UDF</a></li><li><a href="#åœ¨ç³»ç»Ÿä¸­ç®¡ç†å’Œä½¿ç”¨-udf" class="table-of-contents__link toc-highlight">åœ¨ç³»ç»Ÿä¸­ç®¡ç†å’Œä½¿ç”¨ UDF</a><ul><li><a href="#åˆ›å»º-udf" class="table-of-contents__link toc-highlight">åˆ›å»º UDF</a></li><li><a href="#ç®¡ç†-udf" class="table-of-contents__link toc-highlight">ç®¡ç† UDF</a></li><li><a href="#è°ƒç”¨-udf" class="table-of-contents__link toc-highlight">è°ƒç”¨ UDF</a></li></ul></li><li><a href="#udf-çš„ä¸€äº›ä½¿ç”¨é™åˆ¶" class="table-of-contents__link toc-highlight">UDF çš„ä¸€äº›ä½¿ç”¨é™åˆ¶</a></li><li><a href="#ä»£ç é™„ä»¶" class="table-of-contents__link toc-highlight">ä»£ç é™„ä»¶</a><ul><li><a href="#add_onec" class="table-of-contents__link toc-highlight">add_one.c</a></li><li><a href="#democ" class="table-of-contents__link toc-highlight">demo.c</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tddocs/docs">æ–‡æ¡£</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/tdengine" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tddocs/blog">åšå®¢</a></li><li class="footer__item"><a href="https://github.com/taosdata/TDengine" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">@2022 dingbo8128.github.io é¡µé¢å†…å®¹ä»…ä¾›é¢„è§ˆä¸ä¿è¯æ­£ç¡®æ€§</div></div></div></footer></div>
<script src="/tddocs/assets/js/runtime~main.aa837c80.js"></script>
<script src="/tddocs/assets/js/main.74ab57da.js"></script>
</body>
</html>